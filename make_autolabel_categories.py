import pandas as pd
import os

# Имя файла с выборкой
INPUT_FILE = "esf_label_sample_5000.csv"


def categorize_description(desc: str) -> str:
    """
    Возвращает категорию по тексту DESCRIPTION.
    Вместо первого сработавшего правила выбирает категорию
    с наибольшим количеством совпавших ключевых слов.
    """
    if not isinstance(desc, str):
        return None

    text = desc.lower()

    # ---------- словари ключевых слов по категориям ----------

    category_keywords = {
        "Продукты питания и напитки": [
            "йогурт", "кефир", "сметана", "молоко", "масло", "маргарин", "сыр",
            "мука", "макарон", "крупа", "гречка", "сахар", "соль",
            "печенье", "шоколад", "конфет", "чай", "кофе", "какао",
            "сок", "нектар", "лимонад", "напиток", "вода питьевая",
            "колбас", "сосиск", "ветчин", "филе", "мясо", "рыба",
            "подсолнечное масло", "оливковое масло", "мармелад", "марм-д", "перец",  "крылышки",
            "крылыш", "курин", "курица", "клубника", "клубни", "чипсы", "чипс", "бекон",
            "виски", "лаваш", "морожен", "гриб", "вода", "мин вода", "батонч",
            "каша", "кукруза", "тыква", "абрик", "сардел", "манты", "мант", "персик",
            "капуста", "сервелат", "пиво", "пив", "пресерв", "сельд", "лапш", "суп", "яич", "яйцо", "курт",
            "құрт", "сникерс", "snickers", "майонез", "кетчуп", "грейпфрут", "снежок", "клюкв", "повидл",
            "соус", "хлеб", "приправа", "пшениц", "пшен", "вино", "кубики с чесноком", "слива", "сливочн", "коктейл",
            "игрушк", "пельмен", "чечил", "кабач", "семен", "морков", "корж", "паприк", "орех", "карамел",
            "уксус", "творог", "творож", "фундук", "горошек", "шампин", "редьк", "заправк", "шпинат", "фрумелад",
            "бренди", "малютка", "мол смесь", "orbit", "куркума", "корица", "наггетс", "пиала", "тесто", "укроп", "семга",
            "ramen", "рамен", "вафл", "вафли", "закуск", "хлопья", "пирожн", "ячмен", "водк", "коньяк", "курочка ряба",
            "паста", "сухар", "томатная паста", "томат", "драже", "крекер",

        ],

        "Бытовая химия и хозтовары": [
            "порош", "моющее средство", "стиральный порошок", "порошок стиральный",
            "чистящее средство", "средство для мытья", "средство для чистки",
            "освежитель воздуха", "уборка", "дезинфицир",
            "салфетки влажные", "салфетка", "салф", "влажн салф", "влажные салфетки", "губка", "мусорный пакет",
            "перчатки хозяйственные", "шуруп", "скраб", "мыло", "зубная паста", "зубн паста",
            "бальз", "бальзам", "крем", "шампунь", "шампу", "прокладк", "питательная маска",
            "персил", "туалетная бумага", "туалет", "тампон", "tampon", "kotex", "пакет для мусора",
            "щетк", "дезодорант", "парфюм", "набор посуд", "fusion", "пемос", "pantene", "fairy",
            "Морская соль", "белизна", "блеск", "станок", "gillette", "ополаскиватель", "гель для душа", "диски ватные"
        ],

        "Одежда и текстиль": [
            "куртк", "пальто", "жилет", "плащ", "халат", "пижам",
            "футболк", "рубашк", "брюки", "штаны", "комбинезон",
            "спецодежд", "толстовк", "трикотаж", "постельное белье",
            "полотенце", "скатерт", "носки", "носк", "худи", "комбенизон",
            "полукомбениз", "сумк", "шапк", "шапочка", "шорты", "ветровк",
            "леггинс", "костюм", "очки", "adidas", "nike"
        ],

        "Обувь и средства индивидуальной защиты (СИЗ)": [
            "ботинки", "полуботинки", "сапог", "обувь", "кроссовки",
            "спецобувь", "бахилы", "бутсы", "бутс", "сланц",
            "каска", "респиратор", "защитные очки", "щиток защитный",
            "перчатки защитные", "сиз"
        ],

        "Ювелирные изделия и аксессуары": [
            "кольцо", "кольца", "серьг", "браслет",
            "ожерелье", "цепочк", "ag 925", "серебр", "золот"
        ],

        "Лекарства": [
            "мазь", "табл", "таб", "крем", "сироп", "капли", "лекарственное средство",
            "гель", "суспензия", "сусп", "инъекцион", "ампул", "антисептик", "вазелин", "вазел", "анти",
            "спрей", "спре", "наз", "флак", "капс", "капсул", "пастилки", "пастилк", "ибуфен",
            "метронидазол", "вагин", "суппоз", "мочегонн", "лосьон", "пантенол"
        ],

        "Медицинские изделия и расходники": [
            "шприц", "катетер", "бинт", "марля", "пластырь", "перчатки медицинские",
            "игл", "инфузионн", "глюкометр", "системa для", "томограф",
            "аппарат", "медицинск", "хирургическ", "компрессионный", "стент", "презерватив",
            "вата"
        ],

        "Зоотовары": [
            "корм", "корм для кош", "корм для собак", "корм для кот", "корм для щен",
            "зоотовар", "наполнитель для кошачьего туалета", "поводок", "повод", "ошейник", "намордник",
            "шлея"
        ],

        "Детские товары / гигиена": [
            "подгузник", "памперс", "детские салфетки", "детские подгузники",
            "смесь детская", "детское питание", "коляска", "детский крем", "игрушка",
            "игрушк", "трусики", "pampers", "пустышк", "брел", "соск"
        ],

        "Строительные материалы и отделка": [
            "краска", "эмаль", "штукатурк", "шпатлевк", "грунтовк",
            "цемент", "бетон", "кирпич", "плитка", "керамогранит",
            "дверь", "окно", "панель", "профиль", "гипсокартон",
            "саморез", "болт", "гайка", "анкеры", "крепеж",
            "труба", "кабель-канал", "кабель канал", "фурнитура", "уплотнительн",
            "песок", "урна", "шуруп", "зажим", "резьб", "комплект", "провод", "раковин",
            "профлист", "кабель", "монтажная пена"
        ],

        "Оборудование и инструмент": [
            "сварочный аппарат", "дрель", "перфоратор", "болгарка",
            "компрессор", "насос", "расходомер", "преобразователь давления",
            "станок", "инструмент", "генератор", "логгер", "манометр", "смеситель", "смесит",
            "кондиционер", "реле", "кронштейн", "бойлер", "швейная машина", "стабилизатор",
            "apple",
        ],

        "Автозапчасти и сервис авто": [
            "автозапчаст", "амортизатор", "шаровая опора", "рулевой наконечник",
            "тяга", "ступица", "колодк тормоз", "фильтр масляный",
            "фильтр воздушн", "масло моторное", "антифриз", "шина", "покрышка",
            "mtз", "мтз", "газель", "ford", "toyota", "hyundai",
            "ремонт автомобиля", "обслуживание автомобиля", "эстака", "подвеск", "сальник", "сальн",
            "патрубки", "патрубок", "патруб", "бензонасос", "бенз", "замена", "замен", "поршен", "поршн",
            "хомут", "крестовин", "кардан", "ремен", "подшипн", "клапан", "стабилизатор", "антифриз",
            "цилиндр", "шестерн", "пыльник", "втулк", "шатун", "коробк передач", "свеча зажигания", "свеч",
            "фильтр", "очиститель двигателя", "валик", "фар", "стартер", "датчик", "карбюратор", "заглушк",
            "кузов", "радиатор", "муфт", "мойка"
        ],

        "Офисная техника и расходники": [
            "принтер", "мфу", "копир", "сканер", "картридж", "тонер",
            "струйный", "лазерный", "этикетк принтера", "термопринтер", "плоттер",
            "телевизор", "теле", "удлинитель", "вентилят", "тумб", "компьютер", "ПК"
        ],

        "Канцтовары и упаковка": [
            "бумага", "лист a4", "тетрад", "блокнот", "ежедневник",
            "ручка", "маркер", "карандаш", "файл вкладыш", "папка",
            "скоросшиватель", "степлер", "скрепки",
            "коробка", "упаковка", "конверт", "ножниц"
        ],

        "IT-услуги и лицензии": [
            "sap", "oracle", "1с", "лиценз", "лицензия", "подписк",
            "программн", "software", "база данных", "информационн систем",
            "поддержка по", "поддержка sap", "роялти", "royalty"
        ],

        "Рекламные и маркетинговые услуги": [
            "реклам", "наружной рекламы", "наружная реклама",
            "баннер", "билборд", "mupi", "мупи",
            "размещение постеров", "изготовление постеров", "рекламная кампания",
            "печать постеров", "печать"
        ],

        "Транспортно-логистические услуги": [
            "перевозк", "доставк", "логист", "транспортн услуга",
            "жд перевозка", "услуги по отправке", "вагон", "контейнер",
            "платформ", "экспедирован", "абонплата", "абонпл"
        ],

        "Аренда оборудования и прочая аренда": [
            "аренда", "прокат", "рента"
        ],

        "Переводческие, образовательные и консалтинговые услуги": [
            "перевод", "услуги перевода", "обучен", "тренинг",
            "семинар", "консультац", "консалтинговые услуги",
            "коучинг", "редактирован"
        ],
    }

    service_indicators = [
        "услуга", "услуг", "допуслуг", "услуги страхового агента", "работа", "проведение", "оказание", "организация",
        "обслуживание", "сервис", "поддержка", "монтаж", "демонтаж", "реабилитация", "мед. реабилитация", "реабил", "лечение",
        "лечен", "диагностик", "строительство", "строит", "эксплуатац", "вызов", "изготовлен", "автоуслуг", "компьютерные услуги",
        "замен", "баннер", "Пуско-наладочные работы", "подключен", "заливк", "администр", "здание", "сумен жабдықтау",
        "возмещен", "пересылк", "укладк", "проживан", "зарядка", "перезарядка", "установка", "хранение"
    ]

    # ---------- считаем очки по категориям ----------

    best_category = None
    best_score = 0

    for category, keywords in category_keywords.items():
        score = 0
        for k in keywords:
            if k in text:
                score += 1
        if score > best_score:
            best_score = score
            best_category = category

    # Если ни одна категория не набрала ни одного совпадения — fallback
    if best_score == 0:
        if any(k in text for k in service_indicators):
            return "Прочие услуги"
        else:
            return "Прочие товары"

    return best_category


def main():
    if not os.path.exists(INPUT_FILE):
        print(f"Файл {INPUT_FILE} не найден в текущей папке.")
        return

    print(f"Читаем файл: {INPUT_FILE}")
    # Если вдруг будут проблемы с кодировкой, то можно попробовать encoding='cp1251'
    df = pd.read_csv(INPUT_FILE, encoding="utf-8")

    if "DESCRIPTION" not in df.columns:
        print("В файле нет колонки 'DESCRIPTION'. Проверь структуру CSV.")
        return

    print("Авторазметка категорий по колонке DESCRIPTION...")
    df["CATEGORY"] = df["DESCRIPTION"].apply(categorize_description)

    # Перезаписываем тот же файл
    df.to_csv(INPUT_FILE, index=False, encoding="utf-8-sig")
    print(f"Готово! Колонка CATEGORY заполнена и сохранена в {INPUT_FILE}")


if __name__ == "__main__":
    main()
